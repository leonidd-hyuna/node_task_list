<!DOCTYPE html>
<html>
	<head>
		<title><%= title %></title>
			<link rel="stylesheet" href="/css/bootstrap.min.css">
			<script src="/js/jquery.min.js"></script>
			<script src="/js/bootstrap.min.js"></script>
			<link rel='stylesheet' href='/stylesheets/style.css' />
	</head>
	<body>
		<h1><%= title %></h1>
		<a class="btn btn-primary" id="refresh_tasks_list_submit">refreshData</a>

		<br />
	    <table id="taskList" class="table table-striped table-bordered">
		    <thead>
			    <th>id</th>
			    <th>title</th>
			    <th>Date Scheduled</th>
			    <th>Date Finished</th>
		    </thead>
	    </table>

		<h4>Add New Task</h4>
		<form action="" id="insert_new_task">
			<label for="title">Title</label>
			<input type="text" id="title" name="title" >
			<label for="description">Description</label>
			<input type="text" id="description" name="description" >
			<label for="date_scheduled">Date Scheduled</label>
			<input type="date" id="date_scheduled" name="date_scheduled" >
			<button class="btn btn-primary" id="insert_new_task_submit">addTask</button>
		</form>
	</body>
</html>

<script>
	$( document ).ready(function() {
		$("#refresh_tasks_list_submit").on('click',function(){getData(); return false;});
		$("#insert_new_task_submit").on('click',function(){addNewTask(); return false;});
		$("#delete_task_submit").on('click',function(){deleteTask(); return false;});

	});

	function refreshData(result) {
		resultData = '<thead>'
						+'<th>id</th>'
						+'<th>Title</th>'
						+'<th>Description</th>'
						+'<th>Date Scheduled</th>'
						+'<th>Date Finished</th>'
						+'<th>Task Actions</th>'
					+'</thead>';
		$.each(result, function (num, row) {
			var deleteButton = '<a class="btn btn-primary delete_task_submit">Delete</a>';
			resultData = resultData
					+'<tr><td class="taskId">'+row.id+'</td>'
					+'<td>'+row.title+'</td>'
					+'<td>'+row.description+'</td>'
					+'<td>'+row.date_scheduled+'</td>'
					+'<td>'+row.date_finished+'</td>';
					+'<td>'+deleteButton+'</td></tr>';
		});
		$('#taskList').html(resultData);
	}

	function getData() {
		var ajaxOptions = {
			type: "GET",
			url: '/getTasks',
		};
		$.ajax(ajaxOptions)
				.done(function (data) {
					refreshData(data);
				})
				.fail(function (data) {
//					alertData('fail');
				});
//				.always(function (data) {
//					alertData('always');
//				});
	}

	function addNewTask() {
		var ajaxOptions = {
			type: "POST",
			url: '/addNewTask',
			data: $("#insert_new_task").serialize(),
		};
		$.ajax(ajaxOptions)
				.done(function (data) {
					getData();
					alert("inserted "+data.affectedRows+"with id="+data.insertId);
				})
				.fail(function (data) {
//				alertData('fail');
				});
//				.always(function (data) {
//					alertData('always');
//				});
	}

	function deleteTask() {
		var row = $(this).closest("tr"),
            currentId = row.find(".taskId").text();
		    ajaxOptions = {
                type: "DELETE",
                url: '/deleteTask/'+currentId,
            };
		$.ajax(ajaxOptions)
				.done(function (data) {
					getData();
					alert("deleted "+data.affectedRows+" row ");
				})
				.fail(function (data) {
//				alertData('fail');
				});
//				.always(function (data) {
//					alertData('always');
//				});
	}
</script>